---
wave: 2
depends_on:
  - 17-01
files_modified:
  - tests/test_system/test_role_detection.py
  - tests/test_system/test_user_management.py
autonomous: true
---

# Plan 17-03: Role Detection and User Management Tests

## Objective

Create comprehensive tests for the role detection system and user management features. These tests verify that users are correctly categorized as Admin/VIP/Free based on priority rules, and that admin operations on users (change role, block, kick) work correctly.

## Context

The bot has a sophisticated role detection system:
- **Priority**: Admin > VIP Subscription > VIP Channel > Free
- **Stateless**: Always recalculates from fresh data (no caching)
- **Services**: RoleDetectionService, UserManagementService, RoleChangeService
- **Database**: Users table with role enum, UserRoleChangeLog for audit trail

**Current State:**
- RoleDetectionService detects role in real-time
- UserManagementService handles admin operations on users
- RoleChangeService logs all role changes
- Audit trail in UserRoleChangeLog table

**Why This Matters:**
- Incorrect role detection = wrong menus = broken user experience
- Admin operations on users need audit trails for accountability
- Role changes should be logged and reversible
- Priority rules must be enforced consistently

## Success Criteria

1. Tests verify role detection priority (Admin > VIP > Free)
2. Tests verify role detection is stateless (no caching)
3. Tests verify admin can change user roles with logging
4. Tests verify admin can block/unblock users
5. Tests verify admin can kick users from channels
6. Tests verify role changes create audit log entries

## Tasks

### Task 1: Create Role Detection Tests

**File:** `tests/test_system/test_role_detection.py`

Create tests for role detection service:

```python
# Test 1: Admin role has highest priority
async def test_admin_role_highest_priority(test_session, mock_bot):
    """Verify Admin role overrides VIP and Free."""
    from bot.services.role_detection import RoleDetectionService
    from bot.database.models import VIPSubscriber, User
    from bot.database.enums import UserRole
    from datetime import datetime, timezone, timedelta
    from config import Config

    # Create user with active VIP subscription
    user_id = 123456789
    user = User(
        user_id=user_id,
        username="admin_vip_user",
        role=UserRole.VIP
    )
    test_session.add(user)

    subscriber = VIPSubscriber(
        user_id=user_id,
        subscribed_at=datetime.now(timezone.utc),
        expires_at=datetime.now(timezone.utc) + timedelta(days=30)
    )
    test_session.add(subscriber)
    await test_session.commit()

    # Mock Config.is_admin to return True
    with unittest.mock.patch.object(Config, 'is_admin', return_value=True):
        role_service = RoleDetectionService(test_session, mock_bot)
        detected_role = await role_service.get_user_role(user_id)

    # Admin should override VIP
    assert detected_role == UserRole.ADMIN

# Test 2: VIP subscription takes priority over VIP channel
async def test_vip_subscription_over_channel(test_session, mock_bot):
    """Verify active VIP subscription has priority over channel membership."""
    from bot.services.role_detection import RoleDetectionService
    from bot.database.models import VIPSubscriber
    from bot.database.enums import UserRole
    from datetime import datetime, timezone, timedelta

    user_id = 987654321

    # Create expired VIP subscription (user was VIP but expired)
    expired_sub = VIPSubscriber(
        user_id=user_id,
        subscribed_at=datetime.now(timezone.utc) - timedelta(days=60),
        expires_at=datetime.now(timezone.utc) - timedelta(days=30)  # Expired
    )
    test_session.add(expired_sub)
    await test_session.commit()

    # Mock bot.get_chat_member to return "member" (in channel)
    async def mock_get_chat_member(chat_id, user_id):
        from aiogram.types import ChatMember
        return ChatMember(
            user=unittest.mock.MagicMock(id=user_id),
            status="member"
        )

    mock_bot.get_chat_member = mock_get_chat_member

    role_service = RoleDetectionService(test_session, mock_bot)
    detected_role = await role_service.get_user_role(user_id)

    # Should be FREE (subscription expired, no active subscription)
    assert detected_role == UserRole.FREE

# Test 3: VIP subscription detected correctly
async def test_vip_subscription_detected(test_session, mock_bot):
    """Verify active VIP subscription is detected."""
    from bot.services.role_detection import RoleDetectionService
    from bot.database.models import VIPSubscriber
    from bot.database.enums import UserRole
    from datetime import datetime, timezone, timedelta

    user_id = 111222333

    # Create active VIP subscription
    subscriber = VIPSubscriber(
        user_id=user_id,
        subscribed_at=datetime.now(timezone.utc) - timedelta(days=15),
        expires_at=datetime.now(timezone.utc) + timedelta(days=15)
    )
    test_session.add(subscriber)
    await test_session.commit()

    role_service = RoleDetectionService(test_session, mock_bot)
    detected_role = await role_service.get_user_role(user_id)

    assert detected_role == UserRole.VIP

# Test 4: Expired VIP subscription returns Free
async def test_expired_vip_returns_free(test_session, mock_bot):
    """Verify expired VIP subscription results in Free role."""
    from bot.services.role_detection import RoleDetectionService
    from bot.database.models import VIPSubscriber
    from bot.database.enums import UserRole
    from datetime import datetime, timezone, timedelta

    user_id = 222333444

    # Create expired VIP subscription
    subscriber = VIPSubscriber(
        user_id=user_id,
        subscribed_at=datetime.now(timezone.utc) - timedelta(days=60),
        expires_at=datetime.now(timezone.utc) - timedelta(days=1)  # Expired yesterday
    )
    test_session.add(subscriber)
    await test_session.commit()

    role_service = RoleDetectionService(test_session, mock_bot)
    detected_role = await role_service.get_user_role(user_id)

    assert detected_role == UserRole.FREE

# Test 5: No subscription returns Free
async def test_no_subscription_returns_free(test_session, mock_bot):
    """Verify user with no subscription is Free."""
    from bot.services.role_detection import RoleDetectionService
    from bot.database.enums import UserRole

    user_id = 333444555

    # No VIP subscription in database

    role_service = RoleDetectionService(test_session, mock_bot)
    detected_role = await role_service.get_user_role(user_id)

    assert detected_role == UserRole.FREE

# Test 6: Role detection is stateless (no caching)
async def test_role_detection_is_stateless(test_session, mock_bot):
    """Verify role detection doesn't cache results."""
    from bot.services.role_detection import RoleDetectionService
    from bot.database.models import VIPSubscriber
    from bot.database.enums import UserRole
    from datetime import datetime, timezone, timedelta

    user_id = 444555666

    # First call - no subscription
    role_service = RoleDetectionService(test_session, mock_bot)
    role1 = await role_service.get_user_role(user_id)
    assert role1 == UserRole.FREE

    # Add VIP subscription
    subscriber = VIPSubscriber(
        user_id=user_id,
        subscribed_at=datetime.now(timezone.utc),
        expires_at=datetime.now(timezone.utc) + timedelta(days=30)
    )
    test_session.add(subscriber)
    await test_session.commit()

    # Second call - should detect VIP (no cache)
    role2 = await role_service.get_user_role(user_id)
    assert role2 == UserRole.VIP

    # Verify different service instance also detects VIP
    role_service2 = RoleDetectionService(test_session, mock_bot)
    role3 = await role_service2.get_user_role(user_id)
    assert role3 == UserRole.VIP
```

### Task 2: Create User Management Tests

**File:** `tests/test_system/test_user_management.py`

Create tests for user management operations:

```python
# Test 1: Get user info
async def test_get_user_info(test_session, mock_bot):
    """Verify admin can retrieve detailed user information."""
    from bot.services.user_management import UserManagementService
    from bot.database.models import User
    from bot.database.enums import UserRole

    user_id = 123456789
    user = User(
        user_id=user_id,
        username="testuser",
        first_name="Test",
        last_name="User",
        role=UserRole.FREE
    )
    test_session.add(user)
    await test_session.commit()

    user_mgmt_service = UserManagementService(test_session, mock_bot)
    info = await user_mgmt_service.get_user_info(user_id)

    assert info is not None
    assert info["user_id"] == user_id
    assert info["username"] == "testuser"
    assert info["role"] == UserRole.FREE

# Test 2: Change user role
async def test_change_user_role(test_session, mock_bot):
    """Verify admin can change user role."""
    from bot.services.user_management import UserManagementService
    from bot.database.models import User, UserRoleChangeLog
    from bot.database.enums import UserRole
    from datetime import datetime, timezone

    user_id = 987654321
    admin_id = 111111111

    user = User(
        user_id=user_id,
        username="promote_user",
        role=UserRole.FREE
    )
    test_session.add(user)
    await test_session.commit()

    user_mgmt_service = UserManagementService(test_session, mock_bot)

    # Change role from FREE to VIP
    success, message = await user_mgmt_service.change_user_role(
        user_id=user_id,
        new_role=UserRole.VIP,
        changed_by=admin_id
    )

    assert success is True

    # Verify role changed in database
    await test_session.refresh(user)
    assert user.role == UserRole.VIP

    # Verify audit log entry created
    log_entries = await test_session.execute(
        select(UserRoleChangeLog).where(
            UserRoleChangeLog.user_id == user_id,
            UserRoleChangeLog.changed_by == admin_id
        )
    )
    log = log_entries.scalar_one_or_none()
    assert log is not None
    assert log.old_role == UserRole.FREE
    assert log.new_role == UserRole.VIP

# Test 3: Block user
async def test_block_user(test_session, mock_bot):
    """Verify admin can block a user."""
    from bot.services.user_management import UserManagementService
    from bot.database.models import User
    from bot.database.enums import UserRole

    user_id = 222333444
    admin_id = 111111111

    user = User(
        user_id=user_id,
        username="blockme",
        role=UserRole.FREE,
        is_blocked=False
    )
    test_session.add(user)
    await test_session.commit()

    user_mgmt_service = UserManagementService(test_session, mock_bot)

    success, message = await user_mgmt_service.block_user(
        user_id=user_id,
        blocked_by=admin_id,
        reason="Spam"
    )

    assert success is True

    # Verify user is blocked
    await test_session.refresh(user)
    assert user.is_blocked is True

# Test 4: Unblock user
async def test_unblock_user(test_session, mock_bot):
    """Verify admin can unblock a user."""
    from bot.services.user_management import UserManagementService
    from bot.database.models import User
    from bot.database.enums import UserRole

    user_id = 333444555
    admin_id = 111111111

    user = User(
        user_id=user_id,
        username="blocked_user",
        role=UserRole.FREE,
        is_blocked=True
    )
    test_session.add(user)
    await test_session.commit()

    user_mgmt_service = UserManagementService(test_session, mock_bot)

    success, message = await user_mgmt_service.unblock_user(
        user_id=user_id,
        unblocked_by=admin_id
    )

    assert success is True

    # Verify user is unblocked
    await test_session.refresh(user)
    assert user.is_blocked is False

# Test 5: Kick user from VIP channel
async def test_kick_user_from_vip_channel(test_session, mock_bot):
    """Verify admin can kick user from VIP channel."""
    from bot.services.user_management import UserManagementService
    from bot.database.models import User
    from bot.database.enums import UserRole
    from unittest.mock import AsyncMock

    user_id = 444555666
    admin_id = 111111111
    channel_id = "-1001234567890"

    user = User(
        user_id=user_id,
        username="kickme",
        role=UserRole.VIP
    )
    test_session.add(user)
    await test_session.commit()

    # Mock bot.ban_chat_member
    async def mock_ban(chat_id, user_id, until_date=None, revoke_messages=True):
        return True

    mock_bot.ban_chat_member = mock_ban

    user_mgmt_service = UserManagementService(test_session, mock_bot)

    success, message = await user_mgmt_service.kick_user_from_channel(
        user_id=user_id,
        channel_id=channel_id,
        kicked_by=admin_id
    )

    assert success is True
    # Verify bot.ban_chat_member was called

# Test 6: Get user list with pagination
async def test_get_user_list_pagination(test_session, mock_bot):
    """Verify admin can get paginated list of users."""
    from bot.services.user_management import UserManagementService
    from bot.database.models import User
    from bot.database.enums import UserRole

    # Create multiple users
    for i in range(25):
        user = User(
            user_id=1000 + i,
            username=f"user{i}",
            role=UserRole.FREE
        )
        test_session.add(user)
    await test_session.commit()

    user_mgmt_service = UserManagementService(test_session, mock_bot)

    # Get first page (20 users)
    users_page1 = await user_mgmt_service.get_user_list(limit=20, offset=0)
    assert len(users_page1) == 20

    # Get second page (5 users)
    users_page2 = await user_mgmt_service.get_user_list(limit=20, offset=20)
    assert len(users_page2) == 5

# Test 7: Get user list filtered by role
async def test_get_user_list_filtered_by_role(test_session, mock_bot):
    """Verify admin can filter users by role."""
    from bot.services.user_management import UserManagementService
    from bot.database.models import User
    from bot.database.enums import UserRole

    # Create users with different roles
    vip_user = User(user_id=1001, username="vip1", role=UserRole.VIP)
    free_user1 = User(user_id=1002, username="free1", role=UserRole.FREE)
    free_user2 = User(user_id=1003, username="free2", role=UserRole.FREE)
    admin_user = User(user_id=1004, username="admin1", role=UserRole.ADMIN)

    test_session.add_all([vip_user, free_user1, free_user2, admin_user])
    await test_session.commit()

    user_mgmt_service = UserManagementService(test_session, mock_bot)

    # Get only FREE users
    free_users = await user_mgmt_service.get_user_list(role=UserRole.FREE)
    assert len(free_users) == 2
    assert all(u.role == UserRole.FREE for u in free_users)

    # Get only VIP users
    vip_users = await user_mgmt_service.get_user_list(role=UserRole.VIP)
    assert len(vip_users) == 1
    assert vip_users[0].role == UserRole.VIP
```

### Task 3: Create Role Change Audit Log Tests

**File:** `tests/test_system/test_role_change_audit.py`

Create tests for audit logging:

```python
# Test 1: Role change creates audit log
async def test_role_change_creates_audit_log(test_session, mock_bot):
    """Verify role changes are logged."""
    from bot.services.user_management import UserManagementService
    from bot.database.models import User, UserRoleChangeLog
    from bot.database.enums import UserRole
    from sqlalchemy import select

    user_id = 555666777
    admin_id = 111111111

    user = User(
        user_id=user_id,
        username="audit_test",
        role=UserRole.FREE
    )
    test_session.add(user)
    await test_session.commit()

    user_mgmt_service = UserManagementService(test_session, mock_bot)

    # Change role
    await user_mgmt_service.change_user_role(
        user_id=user_id,
        new_role=UserRole.VIP,
        changed_by=admin_id
    )

    # Verify audit log
    result = await test_session.execute(
        select(UserRoleChangeLog).where(
            UserRoleChangeLog.user_id == user_id
        ).order_by(UserRoleChangeLog.changed_at.desc())
    )
    log_entry = result.scalar_one_or_none()

    assert log_entry is not None
    assert log_entry.old_role == UserRole.FREE
    assert log_entry.new_role == UserRole.VIP
    assert log_entry.changed_by == admin_id
    assert log_entry.change_reason == "admin_change"

# Test 2: Multiple role changes create multiple logs
async def test_multiple_role_changes_create_logs(test_session, mock_bot):
    """Verify each role change creates separate log entry."""
    from bot.services.user_management import UserManagementService
    from bot.database.models import User, UserRoleChangeLog
    from bot.database.enums import UserRole
    from sqlalchemy import select, func

    user_id = 666777888
    admin_id = 111111111

    user = User(
        user_id=user_id,
        username="multi_audit",
        role=UserRole.FREE
    )
    test_session.add(user)
    await test_session.commit()

    user_mgmt_service = UserManagementService(test_session, mock_bot)

    # First change: FREE -> VIP
    await user_mgmt_service.change_user_role(
        user_id=user_id,
        new_role=UserRole.VIP,
        changed_by=admin_id
    )

    # Second change: VIP -> ADMIN
    await user_mgmt_service.change_user_role(
        user_id=user_id,
        new_role=UserRole.ADMIN,
        changed_by=admin_id
    )

    # Verify 2 log entries
    result = await test_session.execute(
        select(func.count(UserRoleChangeLog.id)).where(
            UserRoleChangeLog.user_id == user_id
        )
    )
    count = result.scalar()
    assert count == 2

# Test 3: Get role change history for user
async def test_get_role_change_history(test_session, mock_bot):
    """Verify admin can view role change history."""
    from bot.services.user_management import UserManagementService
    from bot.database.models import User
    from bot.database.enums import UserRole

    user_id = 777888999
    admin_id = 111111111

    user = User(
        user_id=user_id,
        username="history_user",
        role=UserRole.FREE
    )
    test_session.add(user)
    await test_session.commit()

    user_mgmt_service = UserManagementService(test_session, mock_bot)

    # Make some changes
    await user_mgmt_service.change_user_role(
        user_id=user_id,
        new_role=UserRole.VIP,
        changed_by=admin_id
    )

    await user_mgmt_service.change_user_role(
        user_id=user_id,
        new_role=UserRole.ADMIN,
        changed_by=admin_id
    )

    # Get history
    history = await user_mgmt_service.get_role_change_history(user_id)

    assert len(history) == 2
    assert history[0]["old_role"] == UserRole.VIP
    assert history[0]["new_role"] == UserRole.ADMIN
    assert history[1]["old_role"] == UserRole.FREE
    assert history[1]["new_role"] == UserRole.VIP
```

## Verification

**Manual Verification:**
1. Run `pytest tests/test_system/test_role_detection.py -v` and verify all role detection tests pass
2. Run `pytest tests/test_system/test_user_management.py -v` and verify user management tests pass
3. Run `pytest tests/test_system/test_role_change_audit.py -v` and verify audit log tests pass
4. Run `pytest tests/test_system/test_role_detection.py::test_admin_role_highest_priority -v` to verify priority

**Automated Verification:**
- All role detection tests pass
- All user management tests pass
- Coverage for role detection and user management > 80%
- Tests complete in < 40 seconds

## Anti-Patterns to Avoid

1. **Don't mock the database** - Use real database operations for role changes
2. **Don't forget audit logs** - Every role change must be logged
3. **Don't test priority in wrong order** - Always test Admin > VIP > Free sequence
4. **Don't ignore edge cases** - Expired subscriptions, missing users, invalid roles
5. **Don't skip stateless verification** - Verify no caching in role detection
6. **Don't forget to refresh** - Use `session.refresh()` after database updates

## Notes

- RoleDetectionService is stateless by design - always recalculate
- Use `unittest.mock.patch` for Config.is_admin() in tests
- Mock bot API methods (ban_chat_member, get_chat_member) with AsyncMock
- Audit logs must include: user_id, old_role, new_role, changed_by, timestamp
- Test pagination with realistic data volumes (20+ users)

## References

- RoleDetectionService: `bot/services/role_detection.py`
- UserManagementService: `bot/services/user_management.py`
- RoleChangeService: `bot/services/role_change.py`
- User model: `bot/database/models.py`
- UserRole enum: `bot/database/enums.py`
