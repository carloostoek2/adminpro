---
phase: 16-testing-infrastructure
plan: 05
type: execute
wave: 1
depends_on: [16-01]
files_modified:
  - pytest.ini
  - .coveragerc
  - requirements.txt
  - scripts/coverage.py
autonomous: true

must_haves:
  truths:
    - pytest-cov is installed and configured
    - Coverage runs with pytest --cov=bot
    - HTML report generates successfully
    - Tests and migrations are excluded from coverage
  artifacts:
    - path: .coveragerc
      provides: coverage configuration
      contains: [run], [report], [html] sections
    - path: scripts/coverage.py
      provides: coverage helper script
  key_links:
    - from: pytest --cov=bot
      to: .coveragerc
      via: pytest-cov plugin
---

# Task 16-05: Coverage Reporting Configuration

## Objective
Configure coverage reporting to measure test coverage of the codebase, with support for pytest-cov and configuration for excluding non-essential files.

## Current State Analysis
- pytest-cov not in requirements.txt
- No coverage configuration exists
- No .coveragerc file
- No coverage reporting in pytest.ini

## Requirements (TESTINF-05)
- Configuraci√≥n de coverage reporting
- Exclude tests, migrations, and non-production code
- HTML and terminal output support
- Coverage threshold enforcement (optional)

## Implementation Steps

### 1. Update requirements.txt
Add pytest-cov to development dependencies:

```
# Development & Testing
pytest==7.4.3
pytest-asyncio==0.21.1
pytest-cov==4.1.0
```

### 2. Create .coveragerc Configuration
Create `/data/data/com.termux/files/home/repos/adminpro/.coveragerc`:

```ini
[run]
# Source directories to measure
source =
    bot
    config.py
    main.py

# Omit files/directories from coverage
omit =
    # Tests
    tests/*
    */test_*.py

    # Migrations
    */migrations/*
    */alembic/*

    # Virtual environments
    */venv/*
    */.venv/*
    */env/*

    # IDE and cache
    */.idea/*
    */__pycache__/*

    # Non-production files
    */scripts/*
    setup.py

# Branch coverage (measures both branches of if/else)
branch = True

# Parallel mode for combining coverage from multiple processes
parallel = False

# Data file location
data_file = .coverage

[report]
# Show missing lines in report
show_missing = True

# Skip covered files (only show files with missing coverage)
skip_covered = False

# Sort report by name
sort = Name

# Precision for percentage
precision = 2

# Exclude lines matching these patterns
exclude_lines =
    # pragma: no cover
    def __repr__
    def __str__
    raise AssertionError
    raise NotImplementedError
    if __name__ == .__main__.:
    if TYPE_CHECKING:
    # Abstract methods
    @abstractmethod
    @abc.abstractmethod
    # Logging
    logger.debug
    logger.info
    logger.warning
    logger.error
    logger.critical
    # Defensive code
    pass
    ...

# Fail if coverage is below this percentage
# Uncomment to enforce minimum coverage
# fail_under = 70

[html]
# HTML report directory
directory = htmlcov

# Title for HTML report
title = Telegram Bot Coverage Report

# Skip generating HTML report if no data
skip_covered = False

[xml]
# XML report output (for CI integration)
output = coverage.xml
```

### 3. Update pytest.ini with Coverage Options
Add coverage configuration to pytest.ini:

```ini
[pytest]
asyncio_mode = auto
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*

addopts =
    -v
    --tb=short
    --strict-markers
    # Coverage options (commented out by default, enable with: pytest --cov)
    # --cov=bot
    # --cov=config
    # --cov=main
    # --cov-report=term-missing
    # --cov-report=html
    # --cov-report=xml

markers =
    slow: marks tests as slow (deselect with '-m "not slow"')
    integration: marks tests as integration tests
    unit: marks tests as unit tests
    e2e: marks tests as end-to-end tests
```

### 4. Create Coverage Scripts
Create helper scripts for running coverage:

```python
#!/usr/bin/env python3
"""
Coverage runner script.

Usage:
    python scripts/coverage.py          # Run tests with coverage
    python scripts/coverage.py --html   # Generate HTML report
    python scripts/coverage.py --open   # Open HTML report in browser
"""
import subprocess
import sys
import argparse
import webbrowser
from pathlib import Path


def run_coverage(html=False, open_report=False, fail_under=None):
    """Run pytest with coverage reporting."""
    cmd = [
        "pytest",
        "--cov=bot",
        "--cov=config",
        "--cov=main",
        "--cov-report=term-missing:skip-covered",
    ]

    if html or open_report:
        cmd.append("--cov-report=html")

    if fail_under:
        cmd.append(f"--cov-fail-under={fail_under}")

    # Add any additional arguments passed to the script
    cmd.extend(sys.argv[1:])

    print(f"Running: {' '.join(cmd)}")
    result = subprocess.run(cmd)

    if open_report and result.returncode == 0:
        report_path = Path("htmlcov/index.html").absolute()
        if report_path.exists():
            print(f"\nOpening coverage report: {report_path}")
            webbrowser.open(f"file://{report_path}")

    return result.returncode


def main():
    parser = argparse.ArgumentParser(description="Run tests with coverage")
    parser.add_argument(
        "--html", action="store_true",
        help="Generate HTML coverage report"
    )
    parser.add_argument(
        "--open", action="store_true",
        help="Open HTML report in browser after running"
    )
    parser.add_argument(
        "--fail-under", type=int, metavar="PERCENT",
        help="Fail if coverage is below PERCENT"
    )

    args, remaining = parser.parse_known_args()

    # Pass remaining args to pytest
    sys.argv = [sys.argv[0]] + remaining

    return run_coverage(
        html=args.html or args.open,
        open_report=args.open,
        fail_under=args.fail_under
    )


if __name__ == "__main__":
    sys.exit(main())
```

Save as `/data/data/com.termux/files/home/repos/adminpro/scripts/coverage.py`

### 5. Create Coverage Badge Generator (Optional)
```python
#!/usr/bin/env python3
"""
Generate coverage badge for README.

Usage:
    python scripts/coverage_badge.py
"""
import subprocess
import re
from pathlib import Path


def get_coverage_percentage():
    """Get coverage percentage from pytest-cov output."""
    result = subprocess.run(
        ["pytest", "--cov=bot", "--cov-report=term", "-q"],
        capture_output=True,
        text=True
    )

    # Parse coverage percentage from output
    match = re.search(r"TOTAL\s+\d+\s+\d+\s+(\d+)%", result.stdout)
    if match:
        return int(match.group(1))

    return None


def generate_badge(percentage):
    """Generate markdown badge."""
    color = "red" if percentage < 50 else "yellow" if percentage < 80 else "green"
    badge_url = f"https://img.shields.io/badge/coverage-{percentage}%25-{color}"
    return f"![Coverage]({badge_url})"


def main():
    print("Getting coverage percentage...")
    percentage = get_coverage_percentage()

    if percentage is not None:
        print(f"Coverage: {percentage}%")
        print(f"Badge: {generate_badge(percentage)}")
    else:
        print("Could not determine coverage percentage")
        return 1

    return 0


if __name__ == "__main__":
    exit(main())
```

## Verification Criteria

1. **pytest-cov Installed**: Package is in requirements.txt
2. **Coverage Config Exists**: .coveragerc file exists with proper configuration
3. **Coverage Runs**: `pytest --cov=bot` executes successfully
4. **HTML Report Generated**: `pytest --cov=bot --cov-report=html` creates htmlcov/
5. **Exclusions Work**: Tests and migrations are excluded from coverage

## must_haves for Goal Verification

```python
# These must be TRUE for phase completion:

# 1. Coverage package installed
# Run: pip show pytest-cov
# Must show: Name: pytest-cov, Version: 4.1.0

# 2. Coverage configuration exists
# File: .coveragerc must exist
# Must contain: [run], [report], [html] sections

# 3. Coverage runs successfully
# Command: pytest tests/test_integration.py --cov=bot --cov-report=term
# Must: Complete without errors and show coverage percentage

# 4. HTML report generates
# Command: pytest --cov=bot --cov-report=html
# Must: Create htmlcov/index.html

# 5. Exclusions work
# Coverage report should NOT include:
# - tests/ directory
# - __pycache__/ directories
# - Lines with "pragma: no cover"
```

## Success Criteria
- [ ] pytest-cov added to requirements.txt
- [ ] .coveragerc created with source, omit, and report configuration
- [ ] pytest.ini updated with coverage options
- [ ] Coverage runs: `pytest --cov=bot` works
- [ ] HTML report generates: `pytest --cov=bot --cov-report=html`
- [ ] Tests directory excluded from coverage
- [ ] Migrations excluded from coverage
- [ ] pragma: no cover lines excluded
- [ ] scripts/coverage.py helper script created

## Usage Examples

```bash
# Run tests with terminal coverage report
pytest --cov=bot --cov-report=term

# Run tests with HTML report
pytest --cov=bot --cov-report=html

# Run tests with missing lines shown
pytest --cov=bot --cov-report=term-missing

# Run tests with coverage threshold
pytest --cov=bot --cov-fail-under=70

# Run only unit tests with coverage
pytest -m unit --cov=bot

# Exclude integration tests from coverage
pytest -m "not integration" --cov=bot

# Using the helper script
python scripts/coverage.py --html --open
```
