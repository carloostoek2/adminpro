---
phase: 16-testing-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pytest.ini
  - setup.cfg (or pyproject.toml)
  - requirements.txt (verify)
autonomous: true

must_haves:
  truths:
    - pytest.ini exists with asyncio_mode = auto
    - Async tests run without @pytest.mark.asyncio decorator
    - Existing tests continue to pass
  artifacts:
    - path: pytest.ini
      provides: pytest configuration with asyncio_mode
      contains: asyncio_mode = auto
  key_links:
    - from: pytest.ini
      to: tests/
      via: testpaths configuration
---

# Task 16-01: pytest-asyncio Configuration

## Objective
Configure pytest-asyncio with `async_mode=auto` to enable seamless async test execution without requiring `@pytest.mark.asyncio` decorators on every test function.

## Current State Analysis
- pytest and pytest-asyncio are already in requirements.txt
- Current conftest.py exists but uses deprecated `event_loop` fixture pattern
- Tests currently use `@pytest.mark.asyncio` decorator explicitly
- No pytest.ini or pyproject.toml configuration file exists

## Requirements (TESTINF-01)
- pytest-asyncio configurado con async_mode=auto
- All async tests run without explicit @pytest.mark.asyncio decorator
- Backward compatibility with existing tests

## Implementation Steps

### 1. Create pytest.ini Configuration
Create `/data/data/com.termux/files/home/repos/adminpro/pytest.ini`:

```ini
[pytest]
asyncio_mode = auto
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts =
    -v
    --tb=short
    --strict-markers
markers =
    slow: marks tests as slow (deselect with '-m "not slow"')
    integration: marks tests as integration tests
    unit: marks tests as unit tests
```

### 2. Update conftest.py for Modern pytest-asyncio
Replace deprecated `event_loop` fixture with modern pytest-asyncio patterns:

```python
# Remove the old event_loop fixture (lines 14-22)
# Remove the old db_setup fixture that uses event_loop.run_until_complete

# Add modern fixtures:
@pytest.fixture(scope="session")
def event_loop_policy():
    """Override event loop policy for the test session."""
    return asyncio.get_event_loop_policy()

@pytest.fixture
async def db_session():
    """Fixture: Provides a database session for tests."""
    async with get_session() as session:
        yield session
```

### 3. Verify Requirements
Ensure requirements.txt contains compatible versions:
- pytest>=7.4.0
- pytest-asyncio>=0.21.0

## Verification Criteria

1. **Configuration File Exists**: pytest.ini exists with asyncio_mode = auto
2. **Tests Run Without Decorator**: Create a test file that runs async tests without @pytest.mark.asyncio
3. **Existing Tests Pass**: All existing tests continue to pass
4. **No Deprecation Warnings**: pytest-asyncio doesn't emit deprecation warnings

## must_haves for Goal Verification

```python
# These must be TRUE for phase completion:

# 1. pytest.ini exists with correct configuration
import configparser
config = configparser.ConfigParser()
config.read('pytest.ini')
assert config.get('pytest', 'asyncio_mode') == 'auto'

# 2. Async test runs without decorator
# File: tests/test_async_mode.py
async def test_async_mode_works():
    """This test must pass without @pytest.mark.asyncio"""
    await asyncio.sleep(0.001)
    assert True

# 3. Existing tests still pass
# Run: pytest tests/test_integration.py -v
# All tests must pass
```

## Success Criteria
- [ ] pytest.ini created with asyncio_mode = auto
- [ ] conftest.py updated to remove deprecated patterns
- [ ] Test without @pytest.mark.asyncio passes
- [ ] All existing tests continue to pass
- [ ] No pytest-asyncio deprecation warnings
