---
phase: 09
plan: 06
type: execute
wave: 5
depends_on: [09-04]
files_modified:
  - bot/handlers/admin/users.py
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "Role change confirmation executes successfully and updates user role with audit logging"
  artifacts:
    - path: "bot/handlers/admin/users.py"
      provides: "Fixed callback data parsing"
      contains: "callback_user_role handler with correct index checks"
  key_links:
    - from: "callback_user_role handler"
      to: "callback_user_role_confirm handler"
      via: "callback data parsing"
      pattern: "parts\\[3\\].*confirm"

---

<objective>
Fix Role Change Confirmation Callback Data Parsing

Purpose: Resolve incorrect array index usage in callback_user_role handler causing "ID is invalid" error
Output: Working role change confirmation flow
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/09-user-management/09-UAT.md
@.planning/phases/09-user-management/09-01-SUMMARY.md
@.planning/phases/09-user-management/09-03-SUMMARY.md

# Gap Details (Test 9 - Role Change Confirmation)

**Issue:** ID is invalid error when confirming role change

**Root Cause:** Callback data parsing in callback_user_role is extracting the user ID from the wrong array index. The handler checks parts[4] == 'confirm' but 'confirm' is actually at parts[3]. When the role selection generates confirmation buttons with format 'admin:user:role:confirm:{user_id}:{role}', parts[3] is 'confirm' and parts[4] is the user_id.

**Location:** bot/handlers/admin/users.py, lines 360 and 366

**Required Fix:**
- Line 360: Change from 'if len(parts) > 4 and parts[4] == "confirm"' to 'if len(parts) > 4 and parts[3] == "confirm"'
- Line 366: Change from 'int(parts[3])' to 'int(parts[4])' for user_id extraction

**Callback Data Format:**
- Role selection buttons: admin:user:role:confirm:{user_id}:{role} (6 parts)
- parts[0] = "admin"
- parts[1] = "user"
- parts[2] = "role"
- parts[3] = "confirm"
- parts[4] = "{user_id}"
- parts[5] = "{role}"
</context>

<tasks>

<task type="auto">
  <name>Fix callback data index checks in callback_user_role</name>
  <files>bot/handlers/admin/users.py</files>
  <action>
    In the callback_user_role function (around line 360), fix the callback data parsing:

    1. Line 360 - Change the confirm check from:
       if len(parts) > 4 and parts[4] == "confirm":

    To:
       if len(parts) > 4 and parts[3] == "confirm":

    2. Line 366 - Change the user_id extraction from:
       user_id = int(parts[3]) if len(parts) > 3 else None

    To:
       user_id = int(parts[4]) if len(parts) > 4 else None

    This correctly handles the callback data format "admin:user:role:confirm:{user_id}:{role}" where:
    - parts[3] = "confirm"
    - parts[4] = user_id
    - parts[5] = role

    Reference existing code: The role selection buttons at lines 402, 406, 410 generate callback_data with format "admin:user:role:confirm:{user_id}:{role}"
    Gap reason: Incorrect index checking caused "ID is invalid" error because parts[3] is "confirm", not the user_id
  </action>
  <verify>
    Search for 'if len(parts) > 4 and parts[3] == "confirm"' in bot/handlers/admin/users.py to confirm the fix is applied
  </verify>
  <done>
    callback_user_role handler correctly parses callback data format "admin:user:role:confirm:{user_id}:{role}" with parts[3] == "confirm" check and parts[4] for user_id extraction
  </done>
</task>

</tasks>

<verification>
- Role selection dialog shows VIP, Free, Admin options (excluding current role)
- Clicking role option shows confirmation dialog
- Confirming role change successfully updates user role
- Role change is logged in audit trail
- Success message displays after confirmation
- No "ID is invalid" errors
</verification>

<success_criteria>
Admin can select new role from user detail, confirm the change, and see success message with role updated and audit logged
</success_criteria>

<output>
After completion, create `.planning/phases/09-user-management/09-06-SUMMARY.md`
</output>
