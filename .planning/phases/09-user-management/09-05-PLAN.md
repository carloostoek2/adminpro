---
phase: 09
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - bot/services/interest.py
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "Interests tab displays list of packages user expressed interest in with attended/pending status badges and timestamps without crashing"
  artifacts:
    - path: "bot/services/interest.py"
      provides: "Interest query with eager loading"
      contains: "selectinload(UserInterest.package)"
  key_links:
    - from: "bot/services/message/admin_user.py"
      to: "bot/services/interest.py"
      via: "get_interests() method call"
      pattern: "get_interests.*user_id"

---

<objective>
Fix Interests Tab MissingGreenlet Error

Purpose: Resolve lazy loading issue causing MissingGreenlet error when accessing interest.package in user detail interests tab
Output: Working interests tab without errors
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/09-user-management/09-UAT.md
@.planning/phases/09-user-management/09-01-SUMMARY.md
@.planning/phases/09-user-management/09-02-SUMMARY.md

# Gap Details (Test 7 - Interests Tab)

**Issue:** Interests tab crashes with MissingGreenlet error when accessing interest.package

**Root Cause:** The get_interests() query in interest.py uses .join(ContentPackage) for filtering but doesn't eager load the package relationship with selectinload(). When admin_user.py line 373 accesses interest.package, it triggers lazy loading outside async session context.

**Location:** bot/services/interest.py, line 219

**Required Fix:** Add selectinload(UserInterest.package) to the query options
</context>

<tasks>

<task type="auto">
  <name>Fix eager loading in get_interests query</name>
  <files>bot/services/interest.py</files>
  <action>
    In the get_interests() method (around line 219), modify the query to eager load the package relationship:

    1. Import selectinload at the top of the file (if not already present):
       from sqlalchemy.orm import selectinload

    2. Update the query construction (line ~219) from:
       stmt = select(UserInterest).join(ContentPackage)

    To:
       stmt = select(UserInterest).options(selectinload(UserInterest.package)).join(ContentPackage)

    This ensures the package relationship is loaded within the async session context, preventing the MissingGreenlet error when accessed later.

    Reference existing code: The join(ContentPackage) is used for filtering, but we need selectinload for the relationship.
    Gap reason: Missing eager loading strategy causes lazy loading outside session context
  </action>
  <verify>
    Search for "selectinload(UserInterest.package)" in bot/services/interest.py to confirm the fix is applied
  </verify>
  <done>
    get_interests() query uses selectinload(UserInterest.package) to eager load the package relationship, preventing MissingGreenlet error when accessing interest.package in admin_user.py
  </done>
</task>

</tasks>

<verification>
- Interests tab displays without errors
- Package names are shown correctly (not "Paquete eliminado" for valid packages)
- No MissingGreenlet errors in console
- Status badges (attended/pending) display correctly
- Timestamps display correctly
</verification>

<success_criteria>
User can view Interests tab in user detail without crashes, seeing all interests with package names, status badges, and timestamps
</success_criteria>

<output>
After completion, create `.planning/phases/09-user-management/09-05-SUMMARY.md`
</output>
